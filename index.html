<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Ditboc</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
		<link rel="stylesheet" href="css/main.css">
		<meta name="viewport" content="width=device-width, initial-scale=1">

	</head>
	<body>       
		<table id="datatable"></table>
		
		<nav id="main-menu" class="nav navbar-default"></nav>
		
		<main>  
			<div class="container"></div>
		</main>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
		<script src="https://chriszarate.github.io/sheetrock/dist/jquery.sheetrock.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.1/handlebars.runtime.min.js"></script>
		<script src="js/templates.js"></script>
		<script src="js/main.js"></script>
		<script type="text/javascript">
	        // Store client urls
	        // = getClient();
	        var client = (function ()
	        {
	        	var clients = {
	        		pfa: {
	        			components: 'https://docs.google.com/spreadsheets/d/1dYT1l22KHG6VedgQfd_DF_bQy4AEnst7nFE15u8GT3I#gid=671887640',
	        			edit: 'https://docs.google.com/spreadsheets/d/1dYT1l22KHG6VedgQfd_DF_bQy4AEnst7nFE15u8GT3I#gid=356843021'
	        		},
	        		standard: {
	        			components: 'https://docs.google.com/spreadsheets/d/1PAS_OmAgq9SmkYTr-eNcBsPrGpDuF9DWOguKlIl3yh8#gid=671887640',
	        			edit: 'https://docs.google.com/spreadsheets/d/1PAS_OmAgq9SmkYTr-eNcBsPrGpDuF9DWOguKlIl3yh8#gid=0',
	        		}
	        	};
	        	switch(getUrlParameter('client'))
	        	{
	        		case 'pfa':
	        		return clients.pfa;
	        	}
	        	return clients.standard;
	        })();
	        // var client = getClient();           

	        if (window.location.href.indexOf(".html") == -1) {
	        	window.location.href = "index.html" + window.location.search;
	        }

	        $.fn.sheetrock.options.url = client.edit;
	        $.fn.sheetrock.options.chunkSize = 50;
	        $.fn.sheetrock.options.formatting = true;
	        $.fn.sheetrock.options.headersOff = true;

	        var dataTable = $('#datatable');
	        var componentData = new Array();
	        var pageComponents = new Array();
	        var pageName;

		    (function getComponentData(){
			    	dataTable.sheetrock({
			        url: client.components,

			        columns: {A: 'Component'
					        , D: 'Filename'
					        , E: 'Type'
					        , F: 'HeadingOne'
					        , G: 'HeadingTwo'
					        , H: 'HeadingThree'
					        , I: 'Teaser'
					        , J: 'RichContent'
					        , K: 'LinkText'
					        , L: 'LinkUrl'
					        , M: 'Image'
					        , N: 'Date'
					        , O: 'Price'
					        , P: 'CTAText'
					        , Q: 'CTAUrl'
					        , S: 'UserStoryForPresentation'},

			        // This array becomes the property names of the output javascript object, it must have exactly the same amount of strings as the retrieved columns.
			    	labels: ['Component'
					        , 'Filename'
					        , 'Type'
					        , 'HeadingOne'
					        , 'HeadingTwo'
					        , 'HeadingThree'
					        , 'Teaser'
					        , 'RichContent'
					        , 'LinkText'
					        , 'LinkUrl'
					        , 'Image'
					        , 'Date'
					        , 'Price'
					        , 'CTAText'
					        , 'CTAUrl'
					        , 'UserStoryForPresentation'],

			    	sql: 'Select %Component%, %Filename%, %Type%, %HeadingOne%, %HeadingTwo%, %HeadingThree%, %Teaser%, %RichContent%, %LinkText%, %LinkUrl%, %Image%, %Date%, %Price%, %CTAText%, %CTAUrl%, %UserStoryForPresentation%' ,

			        rowHandler: function(row){               
			        	componentData.push(row.cells);    
			        },        
			})
			})();        

		    (function createMenuStructure(){
		    	var menuStructure = new Array();
		        // checks the list of objects for a "children" property recursively.
		        function childrenCheck(parentObj, childObj){
		        	if(parentObj.Children) {
		        		for(var i = parentObj.Children.length; i >= 0; i--){
		        			if(parentObj.Children[i] != null) {
		        				var currentItem = parentObj.Children[i];
		        				if(currentItem.Id == childObj.Parent){
		        					if(!currentItem.Children){
		        						currentItem["Children"] = new Array();
		        					}
		        					currentItem.Children.unshift(childObj);
		        				} else {
		        					childrenCheck(currentItem, childObj);
		        				}
		        			}
		        		}
		        	}}

		        	dataTable.sheetrock({
		        		sql: 'select %Id%, %Parent%, %Name% where %Name% is not null and %HideInLists% != TRUE',
		        // sql: 'select %Id%, %Parent%, %Name% where %Name% is not null and %HideInLists% != "TRUE"',

			        rowHandler: function(row){
			        	menuStructure.push(row.cells);
			        },
			        userCallback: function(){
			        	for(var i = menuStructure.length; i >= 0; i--) {
			        		if(menuStructure[i] != null){
			        			currentItem = menuStructure[i];
			        			if(currentItem.Parent != (null || "")){
			        				for(var j = 0; j < menuStructure.length; j++){
			        					if(menuStructure[j].Id == currentItem.Parent) {
			        						var parentItem = menuStructure[j];
			        						if(!parentItem.Children){
			        							parentItem["Children"] = new Array();
			        						}
			        						parentItem.Children.unshift(currentItem);
			        						menuStructure.splice(menuStructure.indexOf(currentItem), 1);                                       
			        					} else {
			        						childrenCheck(menuStructure[j], currentItem);
			        					}
			        				}
			        			}
			        		}

			        	}
			        	for(var i = menuStructure.length; i >= 0; i--){
			        		var currentItem = menuStructure[i];
			        		if(currentItem != null){
			        			if(currentItem.Parent != (null || "")){
			        				menuStructure.splice(i, 1);
			        			} else {
			        				delete currentItem["Parent"];
			        			}
			        		}
			        	}
			        	menuObject = {menuitems: menuStructure};
			        }
		    })})();

		    $(document).on('click', 'a[data-page]', function (e) {
		    	var $that = $(this),
		    	pageId = $that.data('page'),
		    	currentLocation = window.location,
		    	wWidth = $(window).width();

		    	if(pageId != null) {         
		    		if ($that.next('ul').length && wWidth <= 768) {
		    			if ($that.hasClass('clicked')) {
		    				window.location.href = addUrlParameter(currentLocation, 'page', pageId);
		    			} else {
		    				$('a[data-page]').removeClass('clicked');
		    				$that.addClass('clicked')
		    			}
		    		} else {
		    			window.location.href = addUrlParameter(currentLocation, 'page', pageId);
		    		}
		    	}
		    });    

		    $(document).on('mouseenter mouseleave', '#main-menu ul li[data-dropdown]', function(e) {
		    	var currentElement = $(e.target);
		    	$('main').css('padding-top', currentElement.offset().top + 50);
		    	if(e.type == "mouseenter") {
					$('.onPage > ul').css('display', 'none');

		    	} else {
		    		$('.onPage > ul').css('display', 'block');
		    		if($('.onPage').length) {
    					$('main').css('padding-top', 50 * $('.onPage').length);
    				}
		    	}
		    });


		    function getUrlParameter(param) {
		    	var pageUrl = location.search.substring(1);
		    	var urlVariables = pageUrl.split('&');
		    	for (var i = 0; i < urlVariables.length; i++) {
		    		var parameterName = urlVariables[i].split("=");
		    		if (parameterName[0] == param) {
		    			return parameterName[1];
		    		}
		    	}};

			function addUrlParameter(url, param, value) {
		        // Using a positive lookahead (?=\=) to find the
		        // given parameter, preceded by a ? or &, and followed
		        // by a = with a value after than (using a non-greedy selector)
		        // and then followed by a & or the end of the string
		        var val = new RegExp('(\\?|\\&)' + param + '=.*?(?=(&|$))'),
		        parts = url.toString().split('#'),
		        url = parts[0],
		        hash = parts[1]
		        qstring = /\?.+$/,
		        newURL = url;

		        // Check if the parameter exists
		        if (val.test(url))
		        {
		        // if it does, replace it, using the captured group
		        // to determine & or ? at the beginning
		        newURL = url.replace(val, '$1' + param + '=' + value);
			    }
			    else if (qstring.test(url))
			    {
			        // otherwise, if there is a query string at all
			        // add the param to the end of it
			        newURL = url + '&' + param + '=' + value;
			    }
			    else
			    {
			        // if there's no query string, add one
			        newURL = url + '?' + param + '=' + value;
			    }

			    if (hash)
			    {
			    	newURL += '#' + hash;
			    }
			    return newURL
		    ;};          

		    function getComponentObjectByName(string){
		    	for(var i = 0; i < componentData.length; i++){
		    		var currentComponent = componentData[i];
		    		if(currentComponent.Component != (null || "")){
		    			if(currentComponent.Component == string){
		    				obj = currentComponent;
		    				return currentComponent;
		    			}
		    		}
		    	}};

	    	function populateTemplate(target, obj, templateFile) {
	    		var dfd = $.Deferred();
	    		if(obj != null){
	    			var template = Handlebars.templates[templateFile.replace('.handlebars', '')];
	    			if (template) {
	    				var html = template(obj);
	    				target.append(html);
	    				dfd.resolve()
	    			} else {
	    				console.warn('"'+templateFile+'" template not found');
	    				dfd.reject();
	    			}

	    		} else {
	    			console.warn('"'+templateFile+'" not found')
	    			dfd.reject();
	    		}
	    		return dfd.promise();
	        // old code
		        // } else {
		        //     for(var i = 0; i < componentData.length; i++) {
		        //         if(componentData[i].Component == componentName){
		        //             var currentComponent = componentData[i];
		        //             var filename = currentComponent.Filename;
		        //             $.get('components/'+ componentType +'-managed/'+ filename).success(function(data){
		        //                 if(componentType == "layout") {
		        //                     target.replaceWith(data);
		        //                 } else {
		        //                     var boundTarget = target.append(data); 
		        //                     if(boundTarget.find('*[data-dynamic]').length) {
		        //                         var dynamicElements = boundTarget.find('*[data-dynamic]');                                
		        //                         dynamicElements.each(function(){
		        //                             var dynamicElement = $(this);
		        //                             switch(dynamicElement.prop('tagName')) {
		        //                                 case 'H1': 
		        //                                  if(currentComponent.HeadingOne != (null || "")) {
		        //                                     dynamicElement.html(currentComponent.HeadingOne);
		        //                                  } else {
		        //                                     dynamicElement.html(pageName)
		        //                                  }
		        //                                 break;
		        //                                 case 'H2':
		        //                                  if(currentComponent.HeadingTwo != (null || "")) {
		        //                                     dynamicElement.html(currentComponent.HeadingTwo);
		        //                                  }
		        //                                 break;
		        //                                 case 'H3':         
		        //                                  if(currentComponent.HeadingThree != (null || "")) {
		        //                                     dynamicElement.html(currentComponent.HeadingThree);
		        //                                  }
		        //                                 break;
		        //                                 case 'A':
		        //                                   if (dynamicElement.attr('data-dynamic') != 'button') {
		        //                                       if(currentComponent.LinkText != (null || "")) {
		        //                                         dynamicElement.html(currentComponent.LinkText)
		        //                                       }
		        //                                       if(currentComponent.LinkUrl != (null || "")) {
		        //                                         if(currentComponent.LinkUrl.indexOf('http') > -1) {
		        //                                             dynamicElement.attr('href', currentComponent.LinkUrl);
		        //                                         } else if(currentComponent.LinkUrl.match(/\d+$/)){
		        //                                             dynamicElement.attr('data-page', currentComponent.LinkUrl);
		        //                                         }
		        //                                       }
		        //                                   }
		        //                                 break;
		        //                                 case 'IMG': 
		        //                                   if(currentComponent.Image != (null || "")) {
		        //                                      dynamicElement.attr('src', currentComponent.Image);
		        //                                   }
		        //                                 break;                                        
		        //                             }
		        //                             switch(dynamicElement.attr('data-dynamic')) {
		        //                                 case 'h1': 
		        //                                  if(currentComponent.HeadingOne != (null || "")) {
		        //                                     dynamicElement.html(currentComponent.HeadingOne);
		        //                                  } else {
		        //                                     dynamicElement.html(pageName)
		        //                                  }
		        //                                 break;
		        //                                 case 'h2':
		        //                                  if(currentComponent.HeadingTwo != (null || "")) {
		        //                                     dynamicElement.html(currentComponent.HeadingTwo);
		        //                                  }
		        //                                 break;
		        //                                 case 'h3':
		        //                                  if(currentComponent.HeadingThree != (null || "")) {
		        //                                     dynamicElement.html(currentComponent.HeadingThree);
		        //                                  }
		        //                                 break;
		        //                                 case 'teaser':
		        //                                     if(currentComponent.Teaser != (null || "")) {
		        //                                         dynamicElement.html(currentComponent.Teaser);
		        //                                     }
		        //                                 break;
		        //                                 case 'richcontent':
		        //                                     if(currentComponent.RichContent != (null || "")) {
		        //                                         dynamicElement.html(currentComponent.RichContent);
		        //                                     }
		        //                                 break;
		        //                                 case 'price':
		        //                                     if(currentComponent.Price != (null || "")) {
		        //                                         dynamicElement.html(currentComponent.Price);
		        //                                     }
		        //                                 break;
		        //                                 case 'date':
		        //                                     if(currentComponent.Date != (null || "")) {
		        //                                         dynamicElement.html(currentComponent.Date);
		        //                                     }
		        //                                 break;
		        //                                 case 'backgroundimage':
		        //                                     if(currentComponent.Image != (null || "")) {
		        //                                        dynamicElement.attr('style', 'background-size: cover; background-position:center center;background-repeat:no-repeat;background-image: url("'+currentComponent.Image+'");');
		        //                                     }
		        //                                 break;
		        //                                 case 'video':
		        //                                     if(currentComponent.Image != (null || "")) {
		        //                                         dynamicElement.attr('src', currentComponent.Image);
		        //                                     }
		        //                                 break;
		        //                                 case 'component':
		        //                                         dynamicElement.attr('title', currentComponent.Component);
		        //                                 break;
		        //                                 case 'button':
		        //                                   if(currentComponent.CTAText != (null || "")) {
		        //                                     dynamicElement.html(currentComponent.CTAText)
		        //                                   }
		        //                                   if(currentComponent.CTAUrl != (null || "")) {
		        //                                     if(currentComponent.CTAUrl.indexOf('http') > -1) {
		        //                                         dynamicElement.attr('href', currentComponent.CTAUrl);
		        //                                     } else if(currentComponent.CTAUrl.match(/\d+$/)){
		        //                                         dynamicElement.attr('data-page', currentComponent.CTAUrl);
		        //                                     }
		        //                                   }
		        //                                 break;
		        //                             }
		        //                         })

		        //                     }
		        //                 }
		        //             })                    
		        //         }
		        //     }

		        // }
	    	};

		    function getPageComponenents(pageId){
		    	dataTable.sheetrock({
		    		labels: ['Components', 'Name'],
		    		headersOff: true,
		    		sql: "Select %Components%, %Name% where %Id% = " + pageId,
		    		rowHandler: function(row){
		    			if(pageName == null){
		    				pageName = row.cells.Name;
		    			}
		    			pageComponents.push(row.cells);
		    		},
		    		userCallback: function(){
		    			populateTemplate($('#main-menu'), menuObject, 'navbar-default').done(function(){
		    				var currentPage = $('li[data-id="'+ getUrlParameter('page') +'"]');
		    				currentPage.addClass('onPage');
		    				currentPage.parents('li').addClass('onPage');
		    				if($('.onPage').length) {
		    					$('main').css('padding-top', 50 * $('.onPage').length);
		    				}
		    			}); 
		    			componentCollection = pageComponents[0].Components,
		    			lbSplitCollection = componentCollection.split("\n");
		    			for(var i=0; i < lbSplitCollection.length; i++) {
		    				$('main > .container').append('<div class="row" data-id="'+ i +'"></div>');                        
		    				var rowCompenents = lbSplitCollection[i].split(','),
		    				latestRow = $('main > .container > .row[data-id="'+ i +'"]');      
		    				for(var j=0; j < rowCompenents.length; j++){
		    					var componentName = rowCompenents[j].trim(),   
		    					colSize = 12 / rowCompenents.length;
		    					latestRow.append('<div class="component col-md-' + colSize +'" data-component="'+ j +'" data-row="'+ i +'"></div>');
		    					var latestCol = $('.component[data-component="'+ j +'"][data-row="'+ i +'"]');
		    					var componentObject = getComponentObjectByName(componentName);
		    					populateTemplate(latestCol, componentObject, componentObject.Filename);  
		    				}
		    			}     
		    		}
		    	});
			};   

			Handlebars.registerHelper("currentPageName",function(){
				return pageName;
			});

			Handlebars.registerPartial("recursiveMenu", Handlebars.templates['recursiveMenu']);

			Handlebars.registerHelper("times", function(n, block) {
				var accum = '';
				for(var i = 0; i < n; ++i)
					accum += block.fn(i);
				return accum;
			});

			Handlebars.registerHelper("contains" ,function(string, val){
				return (val.indexOf(string) > -1);                
			});

			Handlebars.registerHelper('link', function(link) {
				if(link.indexOf('http') > -1){
					return 'href="'+ link +'"';
				} else {
					return 'data-page='+ link;
				}
			});

			getUrlParameter('page') != null ? getPageComponenents(getUrlParameter('page')) : getPageComponenents(1);
		</script>
	</body>
</html>