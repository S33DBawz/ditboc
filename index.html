<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Ditboc</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>       
    <table id="datatable"></table>

    <templates>
       <script type="text/x-handlebars-template" data-component="Panel">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">{{{HeadingThree}}}</h3>
                </div>
                <div class="panel-body">
                    <div>{{{RichContent}}}</div>
                    <a class="btn btn-default hideIfEmpty" data-dynamic="button" role="button"></a><br>
                    <a class="hideIfEmpty" data-dynamic role="button"></a>
                </div>
            </div>
       </script> 
       <script type="text/x-handlebars-template" data-component="Global menu">

       </script>
    </templates>

    <nav id="main-menu">      
    </nav>

    <main>  
        <div class="container">
        </div>
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://chriszarate.github.io/sheetrock/dist/jquery.sheetrock.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
    <script src="js/main.js"></script>
    <script type="text/javascript">

        $.ajaxSetup({
            cache: false
        });
        var sheetId = 0;
        if(getUrlParameter('sheet') != null) {
            var sheetId = getUrlParameter('sheet');
        }
        var spreadSheet = 'https://docs.google.com/spreadsheets/d/1PAS_OmAgq9SmkYTr-eNcBsPrGpDuF9DWOguKlIl3yh8#gid=' + sheetId;
        var dataTable = $('#datatable');
        $.fn.sheetrock.options.url = spreadSheet;
        $.fn.sheetrock.options.chunkSize = 50;
        $.fn.sheetrock.options.formatting = true;
        $.fn.sheetrock.options.headersOff = true;

        function getUrlParameter(param) {
            var pageUrl = location.search.substring(1);
            var urlVariables = pageUrl.split('&');
            for (var i = 0; i < urlVariables.length; i++) {
                var parameterName = urlVariables[i].split("=");
                if (parameterName[0] == param) {
                    return parameterName[1];
                }
            }
        };

        function addUrlParameter(url, param, value) {
            // Using a positive lookahead (?=\=) to find the
            // given parameter, preceded by a ? or &, and followed
            // by a = with a value after than (using a non-greedy selector)
            // and then followed by a & or the end of the string
            var val = new RegExp('(\\?|\\&)' + param + '=.*?(?=(&|$))'),
                parts = url.toString().split('#'),
                url = parts[0],
                hash = parts[1]
                qstring = /\?.+$/,
                newURL = url;

            // Check if the parameter exists
            if (val.test(url))
            {
                // if it does, replace it, using the captured group
                // to determine & or ? at the beginning
                newURL = url.replace(val, '$1' + param + '=' + value);
            }
            else if (qstring.test(url))
            {
                // otherwise, if there is a query string at all
                // add the param to the end of it
                newURL = url + '&' + param + '=' + value;
            }
            else
            {
                // if there's no query string, add one
                newURL = url + '?' + param + '=' + value;
            }

            if (hash)
            {
                newURL += '#' + hash;
            }
            return newURL;
        }
    
       

        var componentData = new Array();
          $(dataTable).sheetrock({
              // This array becomes the property names of the output JSON object, it must have exactly the same amount of strings as the retrieved columns.
              url: 'https://docs.google.com/a/addition.dk/spreadsheets/d/1PAS_OmAgq9SmkYTr-eNcBsPrGpDuF9DWOguKlIl3yh8#gid=671887640',
              
              labels:     ['Component'
                         , 'Filename'
                         , 'Type'
                         , 'HeadingOne'
                         , 'HeadingTwo'
                         , 'HeadingThree'
                         , 'Teaser'
                         , 'RichContent'
                         , 'LinkText'
                         , 'LinkUrl'
                         , 'Image'
                         , 'Date'
                         , 'Price'
                         , 'CTAText'
                         , 'CTAUrl'],

              columns: {A: 'Component'
                        , D: 'Filename'
                        , E: 'Type'
                        , F: 'HeadingOne'
                        , G: 'HeadingTwo'
                        , H: 'HeadingThree'
                        , I: 'Teaser'
                        , J: 'RichContent'
                        , K: 'LinkText'
                        , L: 'LinkUrl'
                        , M: 'Image'
                        , N: 'Date'
                        , O: 'Price'
                        , P: 'CTAText'
                        , Q: 'CTAUrl'},

              sql: 'Select %Component%, %Filename%, %Type%, %HeadingOne%, %HeadingTwo%, %HeadingThree%, %Teaser%, %RichContent%, %LinkText%, %LinkUrl%, %Image%, %Date%, %Price%, %CTAText%, %CTAUrl%',


              rowHandler: function(row){               
                    componentData.push(row.cells);    
              },        
            });

        $(document).on('click', 'a[data-page]', function (e) {

            var pageId = $(e.target).data('page'),
                currentLocation = window.location,
                wWidth = $(window).width();

            if ($(e.target).next('ul').length && wWidth <= 768) {
                if ($(e.target).hasClass('clicked')) {
                    window.location.href = addUrlParameter(currentLocation, 'page', pageId);
                } else {
                    $('a[data-page]').removeClass('clicked');
                    $(e.target).addClass('clicked')
                }
            } else {
                window.location.href = addUrlParameter(currentLocation, 'page', pageId);
            }
        });
    
        function getComponent(target, componentName, componentType, handlebars) {      
            if(handlebars) {     
                var obj = null;
                for(var i = 0; i < componentData.length; i++){
                    var currentComponent = componentData[i];
                    if(currentComponent.Component != (null || "")){
                        if(currentComponent.Component == componentName){
                            obj = currentComponent;
                            break;
                        }
                    }
                }
                if(obj != null){
                    var templateElement = $('script[data-component="'+ componentName +'"]');
                    if(templateElement.length){
                        var source = templateElement.html();
                        var template = Handlebars.compile(source);
                        var context = obj;
                        var html = template(context);
                        target.append(html);
                    } else {
                        console.log('Component template not found');
                    }
                
                } else {
                    console.log('Component not found')
                }
            } else {
                for(var i = 0; i < componentData.length; i++) {
                    if(componentData[i].Component == componentName){
                        var currentComponent = componentData[i];
                        var filename = currentComponent.Filename;
                        $.get('components/'+ componentType +'-managed/'+ filename).success(function(data){
                            if(componentType == "layout") {
                                target.replaceWith(data);
                            } else {
                                var boundTarget = target.append(data); 
                                if(boundTarget.find('*[data-dynamic]').length) {
                                    var dynamicElements = boundTarget.find('*[data-dynamic]');                                
                                    dynamicElements.each(function(){
                                        var dynamicElement = $(this);
                                        switch(dynamicElement.prop('tagName')) {
                                            case 'H1': 
                                             if(currentComponent.HeadingOne != (null || "")) {
                                                dynamicElement.html(currentComponent.HeadingOne);
                                             } else {
                                                dynamicElement.html(pageName)
                                             }
                                            break;
                                            case 'H2':
                                             if(currentComponent.HeadingTwo != (null || "")) {
                                                dynamicElement.html(currentComponent.HeadingTwo);
                                             }
                                            break;
                                            case 'H3':         
                                             if(currentComponent.HeadingThree != (null || "")) {
                                                dynamicElement.html(currentComponent.HeadingThree);
                                             }
                                            break;
                                            case 'A':
                                              if (dynamicElement.attr('data-dynamic') != 'button') {
                                                  if(currentComponent.LinkText != (null || "")) {
                                                    dynamicElement.html(currentComponent.LinkText)
                                                  }
                                                  if(currentComponent.LinkUrl != (null || "")) {
                                                    if(currentComponent.LinkUrl.indexOf('http') > -1) {
                                                        dynamicElement.attr('href', currentComponent.LinkUrl);
                                                    } else if(currentComponent.LinkUrl.match(/\d+$/)){
                                                        dynamicElement.attr('data-page', currentComponent.LinkUrl);
                                                    }
                                                  }
                                              }
                                            break;
                                            case 'IMG': 
                                              if(currentComponent.Image != (null || "")) {
                                                 dynamicElement.attr('src', currentComponent.Image);
                                              }
                                            break;                                        
                                        }
                                        switch(dynamicElement.attr('data-dynamic')) {
                                            case 'h1': 
                                             if(currentComponent.HeadingOne != (null || "")) {
                                                dynamicElement.html(currentComponent.HeadingOne);
                                             } else {
                                                dynamicElement.html(pageName)
                                             }
                                            break;
                                            case 'h2':
                                             if(currentComponent.HeadingTwo != (null || "")) {
                                                dynamicElement.html(currentComponent.HeadingTwo);
                                             }
                                            break;
                                            case 'h3':
                                             if(currentComponent.HeadingThree != (null || "")) {
                                                dynamicElement.html(currentComponent.HeadingThree);
                                             }
                                            break;
                                            case 'teaser':
                                                if(currentComponent.Teaser != (null || "")) {
                                                    dynamicElement.html(currentComponent.Teaser);
                                                }
                                            break;
                                            case 'richcontent':
                                                if(currentComponent.RichContent != (null || "")) {
                                                    dynamicElement.html(currentComponent.RichContent);
                                                }
                                            break;
                                            case 'price':
                                                if(currentComponent.Price != (null || "")) {
                                                    dynamicElement.html(currentComponent.Price);
                                                }
                                            break;
                                            case 'date':
                                                if(currentComponent.Date != (null || "")) {
                                                    dynamicElement.html(currentComponent.Date);
                                                }
                                            break;
                                            case 'backgroundimage':
                                                if(currentComponent.Image != (null || "")) {
                                                   dynamicElement.attr('style', 'background-size: cover; background-position:center center;background-repeat:no-repeat;background-image: url("'+currentComponent.Image+'");');
                                                }
                                            break;
                                            case 'video':
                                                if(currentComponent.Image != (null || "")) {
                                                    dynamicElement.attr('src', currentComponent.Image);
                                                }
                                            break;
                                            case 'component':
                                                    dynamicElement.attr('title', currentComponent.Component);
                                            break;
                                            case 'button':
                                              if(currentComponent.CTAText != (null || "")) {
                                                dynamicElement.html(currentComponent.CTAText)
                                              }
                                              if(currentComponent.CTAUrl != (null || "")) {
                                                if(currentComponent.CTAUrl.indexOf('http') > -1) {
                                                    dynamicElement.attr('href', currentComponent.CTAUrl);
                                                } else if(currentComponent.CTAUrl.match(/\d+$/)){
                                                    dynamicElement.attr('data-page', currentComponent.CTAUrl);
                                                }
                                              }
                                            break;
                                        }
                                    })
                                   
                                }
                            }
                        })                    
                    }
                }
            
            }

        };

        var pageComponents = new Array();
        var pageName = null;
        function getPageComponenents(pageId){
            $(dataTable).sheetrock({
                labels: ['Components', 'Name'],
                headersOff: true,
                sql: "Select %Components%, %Name% where %Id% = " + pageId,
                rowHandler: function(row){
                    if(pageName == null){
                      pageName = row.cells.Name;
                    }
                    pageComponents.push(row.cells);
                },
                userCallback: function(){
                        getComponent($('#main-menu'), 'Global menu', 'layout', false); 
                        componentCollection = pageComponents[0].Components,
                        lbSplitCollection = componentCollection.split("\n");
                        for(var i=0; i < lbSplitCollection.length; i++) {
                            $('main > .container').append('<div class="row" data-id="'+ i +'"></div>');                        
                            var rowCompenents = lbSplitCollection[i].split(','),
                                latestRow = $('main > .container > .row[data-id="'+ i +'"]');      
                            for(var j=0; j < rowCompenents.length; j++){
                                var componentName = rowCompenents[j].trim(),   
                                    colSize = 12 / rowCompenents.length;
                                latestRow.append('<div class="component col-md-' + colSize +'" data-component="'+ j +'" data-row="'+ i +'"></div>');
                                var latestCol = $('.component[data-component="'+ j +'"][data-row="'+ i +'"]');
                                getComponent(latestCol, componentName, 'editorial', true);  
                            }
                        }     
                }
            });
        };   

        getUrlParameter('page') != null ? getPageComponenents(getUrlParameter('page')) : getPageComponenents(1)        
    
    </script>
</body>
</html>