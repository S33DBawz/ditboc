<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Ditboc</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/main.css">
</head>

<body>
    <data>        
         <table id="menuTable"></table>
         <table id="pageComponentsTable"></table>
         <table id="componentTable"></table>
    </data>

    <div id="nav"></div>

    <main>  
        <div class="container">
          
        </div>
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://chriszarate.github.io/sheetrock/dist/jquery.sheetrock.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
    <script src="js/jquery.tabletojson.js"></script>    
    <script type=text/javascript>
        var sheetId = 0;
        if(getUrlParameter('sheet') != null) {
            var sheetId = getUrlParameter('sheet');
        }
        var spreadSheet = 'https://docs.google.com/spreadsheets/d/1PAS_OmAgq9SmkYTr-eNcBsPrGpDuF9DWOguKlIl3yh8#gid=' + sheetId;
        $.fn.sheetrock.options.url = spreadSheet;
        $.fn.sheetrock.options.chunkSize = 50;

        function getUrlParameter(param) {
            var pageUrl = window.location.search.substring(1);
            var urlVariables = pageUrl.split('&');
            for (var i = 0; i < urlVariables.length; i++) {
                var parameterName = urlVariables[i].split("=");
                if (parameterName[0] == param) {
                    return parameterName[1];
                }
            }
        };

        function addUrlParameter(url, param, value) {
            // Using a positive lookahead (?=\=) to find the
            // given parameter, preceded by a ? or &, and followed
            // by a = with a value after than (using a non-greedy selector)
            // and then followed by a & or the end of the string
            var val = new RegExp('(\\?|\\&)' + param + '=.*?(?=(&|$))'),
                parts = url.toString().split('#'),
                url = parts[0],
                hash = parts[1]
                qstring = /\?.+$/,
                newURL = url;

            // Check if the parameter exists
            if (val.test(url))
            {
                // if it does, replace it, using the captured group
                // to determine & or ? at the beginning
                newURL = url.replace(val, '$1' + param + '=' + value);
            }
            else if (qstring.test(url))
            {
                // otherwise, if there is a query string at all
                // add the param to the end of it
                newURL = url + '&' + param + '=' + value;
            }
            else
            {
                // if there's no query string, add one
                newURL = url + '?' + param + '=' + value;
            }

            if (hash)
            {
                newURL += '#' + hash;
            }
            return newURL;
        }
    
        function populateTemplate(datatable, template, target) {
            var tableData = datatable.tableToJSON(),
                source = template.html(),
                template = Handlebars.compile(source),
                context = {item: tableData},
                html = template(context);
                target.append(html);
        };
        var componentData = new Array();
          $('#componentTable').sheetrock({
              url: 'https://docs.google.com/a/addition.dk/spreadsheets/d/1PAS_OmAgq9SmkYTr-eNcBsPrGpDuF9DWOguKlIl3yh8#gid=671887640',
              sql: 'Select %D%, %A%',
              headersOff: true,
              // D = "Filename" & A = "Component"
              userCallback: function(){
                componentData = $('#componentTable').tableToJSON();
                // console.log(componentData);
              }
            });


        function getComponent(target, componentName, componentType, replace) {
            
            for(var i = 0; i < componentData.length; i++) {

                if(componentData[i].Component == componentName){

                    console.log(componentData[i].Component);

                    $.get('components/'+componentType+'-managed/'+ componentData[i].Filename).success(function(data){
                        if(replace) {
                            target.replaceWith(data);
                        } else {
                            target.append(data);
                        }
                    })

                }

            }
        //
            // $('#componentTable').sheetrock({            
            //       url: 'https://docs.google.com/spreadsheets/d/1PAS_OmAgq9SmkYTr-eNcBsPrGpDuF9DWOguKlIl3yh8#gid=671887640',
            //       sql: 'Select %D% where %A% = "' + componentName + '"',
            //       userCallback: function(){
            //         var componentData = $('#componentTable').tableToJSON();

            //          // $.get('components/'+ componentType +'-managed/'+ componentData[0].D).success(function(data){
            //          //    if(replace) {
            //          //        target.replaceWith(data);
            //          //    } else {
            //          //        target.append(data);
            //          //    }
            //          // };

            //       }
            // });

            // $.get('components/'+ componentType +'-managed/'+ componentName +'.html').success(function(data){
            //     if(replace) {
            //         target.replaceWith(data)
            //     } else {
            //         target.append(data)
            //     }
            // }                
        };

        function getPageComponenents(pageId){
            $('#pageComponentsTable').sheetrock({
                sql: "Select %Components% where %Id% = " + pageId,
                userCallback: function(){
                    var pageComponents = $('#pageComponentsTable').tableToJSON(),
                        componentCollection = pageComponents[0].Components,
                        lbSplitCollection = componentCollection.split("\n");
                    for(var i=0; i < lbSplitCollection.length; i++) {
                        $('main > .container').append('<div class="row" data-id="'+ i +'"></div>');                        
                        var rowCompenents = lbSplitCollection[i].split(','),
                            latestRow = $('main > .container > .row[data-id="'+ i +'"]');      
                        for(var j=0; j < rowCompenents.length; j++){
                            var componentName = rowCompenents[j].trim(),   
                                colSize = 12 / rowCompenents.length;
                            latestRow.append('<div class="component col-md-' + colSize +'" data-component="'+ j +'" data-row="'+ i +'"></div>');
                            var latestCol = $('.component[data-component="'+ j +'"][data-row="'+ i +'"]');
                            getComponent(latestCol, componentName, 'editorial', false);                           
                        }
                    }                 
                }
            });
        };     

        // getComponent($('#nav'), 'navbar-default', 'layout', true);

        getUrlParameter('page') != null ? getPageComponenents(getUrlParameter('page')) : getPageComponenents(1)        
    
    </script>
</body>
</html>